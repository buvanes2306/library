<!DOCTYPE html>
<html>
<head>
    <title>ğŸ¯ Multi-Barcode Scanner Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
        .success { background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .test { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .result { background: #e3f2fd; color: #004085; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        .file-input { padding: 10px; margin: 10px; border: 2px dashed #007bff; border-radius: 10px; text-align: center; }
        .barcode-list { background: #f1f3f4; padding: 10px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .processing { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¯ Multi-Barcode Scanner Test</h1>
    
    <div class="success">
        <h2>âœ… Multi-Barcode Detection Implemented!</h2>
        <p><strong>Upgrade:</strong> From single barcode to multi-barcode detection</p>
        <p><strong>Library:</strong> @zxing/library with decodeMultiple()</p>
        <p><strong>Expected:</strong> Detect ALL barcodes in shelf image</p>
    </div>

    <div class="test">
        <h3>ğŸ§ª Test Multi-Barcode Detection</h3>
        <div class="file-input">
            <input type="file" id="imageInput" accept="image/*">
            <p>ğŸ“¤ Choose a shelf image with multiple barcodes</p>
        </div>
        <button onclick="testMultiBarcode()">ğŸ¯ Scan Multiple Barcodes</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
        <div id="status" class="processing" style="display: none;">ğŸ”„ Processing image...</div>
    </div>

    <div class="result">
        <h3>ğŸ“Š Detection Results</h3>
        <p><strong>Total Barcodes Found:</strong> <span id="totalCount">0</span></p>
        <p><strong>Unique Codes:</strong> <span id="uniqueCount">0</span></p>
        <p><strong>Processing Time:</strong> <span id="processingTime">0ms</span></p>
    </div>

    <div class="test">
        <h3>ğŸ“‹ Detected Barcodes</h3>
        <div id="barcodeList" class="barcode-list">
            <p>No barcodes detected yet. Upload an image to test.</p>
        </div>
    </div>

    <div class="warning">
        <h3>ğŸ“‹ Expected Behavior</h3>
        <ul>
            <li>âœ… <strong>Single Barcode:</strong> Still works (backward compatible)</li>
            <li>âœ… <strong>Multiple Barcodes:</strong> Detects ALL barcodes in image</li>
            <li>âœ… <strong>Duplicate Prevention:</strong> No duplicate codes</li>
            <li>âœ… <strong>Performance:</strong> Processes all barcodes simultaneously</li>
            <li>âœ… <strong>Feedback:</strong> Shows count of detected barcodes</li>
        </ul>
    </div>

    <div class="success">
        <h3>ğŸš€ Test in Your Application</h3>
        <p><strong>Scanner Page:</strong> <a href="http://localhost:5173/scanner" target="_blank">http://localhost:5173/scanner</a></p>
        <p><strong>Upload Image:</strong> Choose shelf image with multiple barcodes</p>
        <p><strong>Expected Result:</strong> All barcodes detected and processed</p>
    </div>

    <!-- Include ZXing library -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    
    <script>
        let detectedCodes = new Set();
        let processingStartTime = 0;

        async function testMultiBarcode() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file first');
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            processingStartTime = Date.now();

            try {
                // Create image element
                const img = new Image();
                const objectUrl = URL.createObjectURL(file);
                
                img.onload = async () => {
                    try {
                        // Create canvas for image processing
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        // Get image data
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        // Create luminance source for ZXing
                        const luminanceSource = new ZXing.RGBLuminanceSource(
                            imageData.data,
                            canvas.width,
                            canvas.height
                        );

                        // Create binary bitmap
                        const binaryBitmap = new ZXing.BinaryBitmap(
                            new ZXing.HybridBinarizer(luminanceSource)
                        );

                        // Create multi-format reader
                        const reader = new ZXing.MultiFormatReader();

                        // ğŸ”¥ MAGIC: Decode MULTIPLE barcodes from single image
                        const results = reader.decodeMultiple(binaryBitmap);

                        detectedCodes.clear();

                        if (results && results.length > 0) {
                            // Process each detected barcode
                            for (let result of results) {
                                const raw = result.getText();
                                const numeric = raw.replace(/\D/g, '');
                                const code = numeric || raw;
                                detectedCodes.add(code);
                            }

                            updateResults();
                            statusDiv.innerHTML = `âœ… Success! Found ${results.length} barcodes`;
                            statusDiv.style.background = '#d4edda';
                        } else {
                            statusDiv.innerHTML = 'âŒ No barcodes detected';
                            statusDiv.style.background = '#f8d7da';
                        }
                    } catch (error) {
                        console.error('Multi-barcode detection error:', error);
                        statusDiv.innerHTML = `âŒ Error: ${error.message}`;
                        statusDiv.style.background = '#f8d7da';
                    } finally {
                        statusDiv.style.display = 'block';
                    }
                };

                img.onerror = () => {
                    statusDiv.innerHTML = 'âŒ Failed to load image';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.display = 'block';
                };

                img.src = objectUrl;

            } catch (error) {
                console.error('Processing error:', error);
                statusDiv.innerHTML = `âŒ Processing error: ${error.message}`;
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.display = 'block';
            }
        }

        function updateResults() {
            const processingTime = Date.now() - processingStartTime;
            const barcodeList = document.getElementById('barcodeList');
            
            document.getElementById('totalCount').textContent = detectedCodes.size;
            document.getElementById('uniqueCount').textContent = detectedCodes.size;
            document.getElementById('processingTime').textContent = `${processingTime}ms`;

            if (detectedCodes.size > 0) {
                const codesArray = Array.from(detectedCodes);
                barcodeList.innerHTML = codesArray.map((code, index) => 
                    `<div style="padding: 5px; margin: 2px 0; background: white; border-radius: 3px;">
                        <strong>#${index + 1}:</strong> ${code}
                    </div>`
                ).join('');
            } else {
                barcodeList.innerHTML = '<p>No barcodes detected</p>';
            }
        }

        function clearResults() {
            detectedCodes.clear();
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('uniqueCount').textContent = '0';
            document.getElementById('processingTime').textContent = '0ms';
            document.getElementById('barcodeList').innerHTML = '<p>No barcodes detected yet. Upload an image to test.</p>';
            document.getElementById('status').style.display = 'none';
            document.getElementById('imageInput').value = '';
        }

        // File input change handler
        document.getElementById('imageInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                clearResults();
            }
        });
    </script>
</body>
</html>
